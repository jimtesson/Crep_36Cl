function weightedMeanCalc(b){return valSum=0,weights=[],weightsSum=0,weightedSum=0,swds=[],swdsSums=0,unsNumer=0,unsDenom=0,resUns=0,unsType="Weighted Standard Deviation",nzw=0,_.each(b,function(a){pr=a[0],uns=a[1],w=1/(uns*uns),0!==w&&nzw++,weights.push(w),weightsSum+=w,valSum+=pr}),moy=valSum/b.length,_.each(b,function(a){pr=a[0],uns=a[1],swd=(pr-moy)/uns,swd*=swd,swds.push(swd),swdsSums+=swd}),mswd=swdsSums/(b.length-1),_.each(b,function(a,b){weightedSum+=a[0]*weights[b]}),weightedMean=weightedSum/weightsSum,unsDenom=(nzw-1)*weightsSum/nzw,_.each(b,function(b,c){a=b[0]-weightedMean,a*=a,unsNumer+=a*weights[c]}),b.length>1?(resUnsMSWD=Math.sqrt(1/weightsSum),mswd>1&&(resUnsMSWD*=Math.sqrt(mswd)),resUns=Math.sqrt(unsNumer/unsDenom),resUnsMSWD>resUns&&(resUns=resUnsMSWD,unsType="Error of the weighted mean")):(resUns=b[0][1],unsType=null),console.log("weighted mean : "+weightedMean,",",resUns),[weightedMean,resUns,mswd,unsType]}var markerSelectedIcon=L.icon({shadowSize:[0,0],popupAnchor:[0,-35],iconUrl:"img/marker.png"}),markerSampleIcon={iconUrl:"img/marker-sample.png",iconSize:[25,40],popupAnchor:[0,-35],iconAnchor:[12,40]},markerDefaultIcon=L.icon({popupAnchor:[0,-35],shadowSize:[0,0],iconUrl:"data:image/png;base64,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"}),baseUrl="http://192.168.1.43:3000/",app=angular.module("app",["ui.bootstrap","ui.router","nvd3ChartDirectives","angularRangeSlider","zingchart-angularjs","ui-leaflet"]);app.config(function(a,b){a.state("home",{url:"/",templateUrl:"partials/home.html"}).state("parameters",{url:"/init",templateUrl:"partials/init.html"}).state("production-rate",{url:"/production-rate",templateUrl:"partials/pr-custom.html"}).state("samples",{url:"/samples",templateUrl:"partials/samples.html"}).state("db-error",{url:"/db-error",templateUrl:"partials/db-error.html"}).state("crep-error",{url:"/crep-error",templateUrl:"partials/crep-error.html"}).state("calculation",{url:"/calculation",templateUrl:"partials/calc.html",controller:"testController"}),b.otherwise("/")}),app.controller("mainController",function(a,b,c,d,e,g,h,i){function j(a,b){return value=a[b],prStr=value.split(","),[parseFloat(prStr[0]),parseFloat(prStr[1])]}function k(b,c){return id=b.id,m=_.find(a.regionsMean,{regional_id:id}),m?(value=m[c],prStr=value.split(","),[parseFloat(prStr[0]),parseFloat(prStr[1])]):[0,0]}function l(a,b,c){var d=[];b=1e3*b,c=1e3*c;for(var e=0;e<a.length;e++){var f=a[e].age;f>=b&&c>=f&&d.push(a[e])}return d}a.parentParams={Name:"Testing",gdbName:"Muscheler et al., 2005",execId:Math.floor(1e4*Math.random()+1),Nucl:10,Scheme:1,Atm:0,GMDB:1,PR:[0,0],Samples:[],Age:[0,0],Lat:[0],Lon:[0],Alt:[0],Thick:[0],Shield:[0],Dens:[0],Eros:[0],NuclCon:[0],NuclErr:[0],NuclNorm:[""],Notes:-9999},a.isArray=angular.isArray,a.isString=angular.isString,a.parseInt=parseInt;var n=function(a,b,c){var d="";return scalStr=["LAL","LSD"],atmStr=["ERA","STD"],gdbStr=["M","G","L"],d=d+scalStr[parseInt(a)-1]+atmStr[parseInt(b)]+gdbStr[parseInt(c)-1]};a.genFieldName=function(){a.fieldStr=n(a.params.globalData.Scheme,a.params.globalData.Atm,a.params.globalData.GMDB),console.log(a.fieldStr)};var o=function(){a.params={globalData:_.clone(a.parentParams),prData:{},prRes:[],ageData:{},ageRes:{}},p(),q(),a.prToggle=0};a.resetParams=function(){d.location.reload(),o(),a.tabChange(),a.loadGmdb(a.params.globalData.GMDB),a.prToggle=0,a.agesPDF=[],a.go("init")};var p=function(){a.params.prData=_.extend(a.params.globalData)},q=function(){a.params.ageData={},a.params.ageData=_.extend(a.params.globalData)};o(),a.apiUrl=baseUrl,a.getLocalities=function(){a.localities=[],b({url:baseUrl+"markers/"+a.params.globalData.Nucl,method:"GET",headers:{"Content-Type":"application/json"}}).then(function(b){markers={},a.markers=b.data,a.updateMarkers(0,9e4)},function(b){a.go("db-error"),console.log(b)})},a.getAllLocalitiesMarkers=function(){b({url:baseUrl+"markers/all",method:"GET",headers:{"Content-Type":"application/json"}}).then(function(b){a.allMarkers=b.data},function(b){a.go("db-error"),console.log(b)})},a.getRegions=function(){a.regionsMean=[],a.regions=[],nucl=a.params.globalData.Nucl,10==nucl?nuclStr="10be":nuclStr="3he",b.get("geo-json/regions-"+nuclStr+".json").success(function(c,d){angular.extend(a,{regions:{data:c,style:{fillColor:"green",weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}}),b({url:baseUrl+"regions/mean/"+nucl,method:"GET",headers:{"Content-Type":"application/json"}}).then(function(b){a.regionsMean=b.data},function(a){console.log("Failed to retrieve Regional Mean")})})},a.getWorldMean=function(c,d,e,g){b({url:baseUrl+"world/mean/"+c,method:"GET",headers:{"Content-Type":"application/json"}}).then(function(b){Number.isInteger(a.params.globalData.GMDB)&&(f=a.fieldStr,value=b.data[f],prStr=value.split(","),a.params.globalData.PR=[parseFloat(prStr[0]),parseFloat(prStr[1])])},function(a){console.log("Failed to retrieve World Mean")})},a.getMeanForMarker=j,a.getMeanForRegion=k,a.selectedMarkers=[],a.customPrInput={Age:[]},a.agesLoading=0,a.prInputs=[],a.slhlInput=[],a.min=1,a.max=600,a.gdbTab=!0,a.customPr=!1,a.customPrToggle=0,a.customGdb=!1,a.browsePr=!0,a.prTab=!1,a.gdbData=[{key:"Series 1",values:[]}],a.sampleHelp=!1,a.agesPDF=[],a.loadGmdb=function(c){if(1===c||2===c||3===c){var d=["GMDBMUSCH","GMDBLIFTON","GMDBLSD"],e=d[c-1]+".json",f=["Muscheler et al., 2005","LiftonVDM2016","LSD Framework"];a.params.globalData.gdbName=f[c-1],b.get("js/"+e).success(function(b){lastIndex=_.findLastIndex(b,function(a){return Math.round(a[0])<=100}),slicedVDM=_.slice(b,0,lastIndex+1),a.gdbData[0].values=slicedVDM})}},a.uploadGmdbFile=function(c){var d=new FormData,e=baseUrl+"xlsjs/gmdb";d.append("gmdbFile",c[0]),b.post(e,d,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(b){a.gdbData[0].values=b,a.params.globalData.GMDB=v(b),a.params.globalData.gdbName="Custom"}).error("error")},a.$watch("params.globalData.GMDB",a.loadGmdb(a.params.globalData.GMDB)),a.$watchGroup(["params.globalData.GMDB","params.globalData.Scheme","params.globalData.Atm"],a.genFieldName),a.uploadSampleFile=function(c){var d=new FormData,e=baseUrl+"xlsjs/sample";d.append("sampleFile",c[0]),b.post(e,d,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(b){a.sampleData=r(b),a.genSamplesMarkers()}).error("error")},a.checkSamples=function(){a.outside=0,_.each(a.samplesMarkers,function(b){leafletPip.pointInLayer([b.lng,b.lat],L.geoJson(a.regions.data)).length||a.outside++})},a.samplesMarkers=[],a.genSamplesMarkers=function(){a.samplesMarkers=[];var b=1e3;_.each(a.sampleData,function(c,d){b=b++,m={id:b,message:c.Sample,clickable:!1,icon:markerSampleIcon,name:c.Sample,lng:c.Lon,lat:c.Lat},a.samplesMarkers.push(m)}),a.toggleView("localities"),a.checkSamples()};var r=function(a){var b=["Sample","Lat","Lon","Alt","NuclCon","NuclErr","Shield","Dens","Thick","Eros"],c=Object.keys(a[0]),d={},e=0;_.each(c,function(a,c){d[a]=b[e],e++});var f={},g=function(a,b){b=d[b]||b,f[b]=a},h=[];for(e=0;e<a.length;e++)f={},_.each(a[e],g),h.push(f);return h};a.addPrInput=function(b){var c=0,d=_.cloneDeep(b);_.each(d,function(a,b){c?d[b]=parseFloat(a):(d[b][0]=1e3*parseFloat(a[0]),d[b][1]=1e3*parseFloat(a[1])),c++}),a.prInputs.length||a.prInputs.push(d),a.customPr={}},a.addSlhlInput=function(b){var c=_.cloneDeep(b);c[0]=parseFloat(c[0]),c[1]=parseFloat(c[1]),a.params.globalData.PR=c,a.slhlInput=[]},a.resetInputs=function(){a.prInputs=[]},a.tabChange=function(){c(function(){var a=d.document.createEvent("UIEvents");a.initUIEvent("resize",!0,!1,d,0),d.dispatchEvent(a)})},a.processCustomPr=function(){a.prInputs.length?urlStr="process/userpr/":urlStr="process/multipr/",b({url:baseUrl+urlStr,method:"POST",data:s(a.params),headers:{"Content-Type":"application/json"}}).then(function(b){a.params.globalData.prRes=_.values(b.data)[0]},function(b){a.go("crep-error"),console.log(b)})},a.loadPr=function(){a.params.globalData.PR=a.params.globalData.prRes.SLHLPR};var s=function(b){if(a.prInputs.length<2){inputs=_.cloneDeep(a.prInputs[0]),b.prData=_.merge(b.prData,inputs);var c=_.extend(b.globalData);return c=_.merge(c,b.prData)}var d=_.cloneDeep(b.globalData);return d.prTab=[],_.each(a.prInputs,function(c,e){inputs=_.cloneDeep(a.prInputs[e]),b.prData=_.merge(b.prData,inputs);var f=_.extend(b.globalData);f=_.merge(f,b.prData),d.prTab.push(f)}),d};a.setPrMode=function(b){a.prMode=b};var t=function(b){return sampleMatrix=v(a.sampleData),b.ageData.Samples=sampleMatrix[0],b.ageData.Lat=sampleMatrix[1],b.ageData.Lon=sampleMatrix[2],b.ageData.Alt=sampleMatrix[3],b.ageData.NuclCon=sampleMatrix[4],b.ageData.NuclErr=sampleMatrix[5],b.ageData.Shield=sampleMatrix[6],b.ageData.Dens=sampleMatrix[7],b.ageData.Thick=sampleMatrix[8],b.ageData.Eros=sampleMatrix[9],b.ageData.selectedMarkers=[],prMode=0,_.each(a.selectedMarkers,function(c){b.ageData.selectedMarkers.push(c.model.id),1!=a.prMode||c.model.site_id||(a.prMode=2)}),b.ageData.prMode=a.prMode,age=_.merge(b.globalData,b.ageData),age};a.go=function(b){e.path(b),a.tabChange()},a.processAges=function(){a.agesLoading=1,a.agesPDF=[],b({url:baseUrl+"process/ages",method:"POST",data:t(a.params),headers:{"Content-Type":"application/json"}}).then(function(b){a.params.ageRes=_.values(b.data)[0],a.agesLoading=0,u(a.params.ageRes),a.resetMarkers()},function(b){a.agesLoading=0,a.go("crep-error"),console.log(b)})};var u=function(b){angular.isString(b.Samples)?(samplePDF={key:b.Samples,values:[]},samplePDF.values=b.PDFdisp,a.agesPDF.push(samplePDF),console.log(samplePDF)):_.each(b.Samples,function(c,d){samplePDF={key:c,values:[]},samplePDF.values=b.PDFdisp[d],a.agesPDF.push(samplePDF),console.log(samplePDF)})};a.exportPDF=function(){b({url:baseUrl+"export",method:"GET",responseType:"arrayBuffer",data:a.params,headers:{"Content-Type":"application/json",Accept:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}}).then(function(a,b,c,d){var e=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});saveAs(e,"export.xlsx")},function(b){a.go("crep-error"),console.log(b)})};var v=function(a){return Object.keys(a[0]).map(function(b){return a.map(function(a){return a[b]})})};a.map={center:{latitude:3,longitude:7},zoom:6},angular.extend(a,{layers:{baselayers:{topo:{name:"World Topographic",type:"agsBase",layer:"Topographic",visible:!1},shadedrelief:{name:"ShadedRelief",type:"agsBase",layer:"ShadedRelief",visible:!1},terrain:{name:"Terrain",type:"agsBase",layer:"Terrain",visible:!1}}},noEvents:{markers:{enable:[]},geojson:{disable:["click"]}}}),angular.extend(a,{homeMapSettings:{doubleClickZoom:!1,wheelZoom:!1,zoom:5}}),a.$on("leafletDirectiveMarker.click",function(b,c){id=c.model.id,f=a.fieldStr,mean=j(c.model,f),console.log(id,f,mean,c),a.toggleMarkerIcon(c)}),a.$on("leafletDirectiveMarker.mouseover",function(a,b){b.leafletObject.openPopup()}),a.$on("leafletDirectiveMarker.mouseout",function(a,b){}),a.toggleMarkerIcon=function(b){b.leafletObject._icon&&(elem=angular.element(b.leafletObject._icon),sel=elem.hasClass("selected"),sel?(b.leafletObject.setIcon(markerDefaultIcon),a.popMarker(b),elem.removeClass("selected")):(b.leafletObject.setIcon(markerSelectedIcon),a.pushMarker(b),elem.addClass("selected")))},a.toggleRegion=function(b){elem=angular.element(b.leafletObject._path),sel=elem.hasClass("selected"),b.model.name="",console.log("regionObj",b),sel?(b.leafletObject.setStyle({fillColor:"green"}),a.popMarker(b),elem.removeClass("selected")):(b.leafletObject.setStyle({fillColor:"red"}),a.pushMarker(b),elem.addClass("selected"))},a.pushMarker=function(b){a.selectedMarkers.push(b),console.log("push",b)},a.popMarker=function(b){console.log(b),a.selectedMarkers=_.reject(a.selectedMarkers,function(a){return a.model.id==b.model.id})},a.round=Math.round,a.ceil=Math.ceil,a.log10=Math.log10,a.selectAllMarkers=function(){markers=a.markers,f=a.fieldStr,_.each(markers,function(b){a.selectedMarkers.push({model:b})})},a.resetMarkers=function(){_.each(a.selectedMarkers,function(b){b.model.age?a.toggleMarkerIcon(b):a.toggleRegion(b)})},a.updatePrOnMarkerChange=function(b){a.selectedMarkers.length&&b?(console.log("Markers Selection Changed"),f=a.fieldStr,meanInput=[],_.each(a.selectedMarkers,function(a){a.model.age?pr=j(a.model,f):pr=k(a.model,f),console.log(pr,a.model),meanInput.push(pr)}),a.params.globalData.PR=weightedMeanCalc(meanInput),console.log(a.params.globalData.PR)):a.params.globalData.PR=[0,0]},a.$watch("selectedMarkers.length",a.updatePrOnMarkerChange),a.$watch("prToggle",function(b){a.prToggle?a.params.globalData.PR=[0,0]:a.getWorldMean(a.params.globalData.Nucl,a.params.globalData.Scheme,a.params.globalData.Atm,a.params.globalData.GMDB)}),a.resetPr=function(){a.params.globalData.PR=[0,0]},a.$watchGroup(["params.globalData.GMDB","params.globalData.Scheme","params.globalData.Atm","params.globalData.Nucl"],function(){a.prToggle||a.getWorldMean(a.params.globalData.Nucl,a.params.globalData.Scheme,a.params.globalData.Atm,a.params.globalData.GMDB)}),a.$watch("params.globalData.Nucl",function(){a.getLocalities(),a.getRegions(),a.resetMarkers()}),a.$on("leafletDirectiveGeoJson.click",function(b,c){console.log("click on Region ",c),f=a.fieldStr,pr=k(c.model,f),a.toggleRegion(c)}),a.markers=[],a.filterSelectedMarkers=function(a,b,c){return a.model.age},a.filterSelectedRegions=function(a,b,c){return"Feature"===a.model.type},a.toggleView=function(b){a.mapView=b,a.resetMarkers(),"localities"==b?(i.getMap().then(function(a){a.eachLayer(function(a){a._icon&&a.options&&a.options.age&&angular.element(a._icon).removeClass("hidden"),a.feature&&(console.log(a),angular.element(a._container).addClass("hidden"))})}),a.markersDisplayed=a.markersFiltered.concat(a.samplesMarkers)):"regions"==b&&(a.geojson=a.regions,i.getMap().then(function(a){a.eachLayer(function(a){a.feature&&angular.element(a._container).removeClass("hidden"),a._icon&&a.options&&a.options.age&&angular.element(a._icon).addClass("hidden")})}))},a.mapView="localities",a.range=l,a.updateMarkers=function(b,c){a.markersFiltered=l(a.markers,b,c),a.markersDisplayed=a.markersFiltered.concat(a.samplesMarkers)},a.$on("$stateChangeSuccess",a.tabChange)}),app.controller("testController",function(a){});